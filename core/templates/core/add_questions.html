{% extends 'core/base.html' %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã{% endblock %}

{% block extra_css %}
<style>
    .answer-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border: 1px solid #e2e8f0;
    }
    
    .correct-answer {
        background: #f0fff4;
        border-color: #9ae6b4;
    }
    
    .answer-text {
        flex-grow: 1;
    }
    
    .remove-answer {
        color: #e53e3e;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.5rem;
    }
    
    .add-answer-btn {
        background: #ebf8ff;
        color: #2b6cb0;
        border: 2px dashed #90cdf4;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.3s;
    }
    
    .add-answer-btn:hover {
        background: #bee3f8;
        border-color: #4299e1;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; padding: 2rem 1rem;">
    <div style="background: rgba(255,255,255,0.95); border-radius: 10px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e2e8f0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    ‚ùì
                </div>
                <div>
                    <h1 style="color: #2d3748; margin: 0; font-size: 1.75rem;">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</h1>
                    <p style="color: #718096; margin: 0.25rem 0 0;">
                        –ó–∞–¥–∞–Ω–∏–µ: {{ task.title }} ({{ task.get_task_type_display }})
                    </p>
                </div>
            </div>
            
            <div>
                <a href="{% url 'manage_questions' task.id %}" 
                   style="display: inline-flex; align-items: center; padding: 0.5rem 1rem; background: #e2e8f0; color: #4a5568; text-decoration: none; border-radius: 5px; font-size: 0.9rem;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏
                </a>
            </div>
        </div>

        <form method="post" id="question-form">
            {% csrf_token %}
            
            <!-- –í–æ–ø—Ä–æ—Å -->
            <div style="margin-bottom: 2rem;">
                <label for="{{ question_form.text.id_for_label }}" 
                       style="display: block; color: #2d3748; margin-bottom: 0.5rem; font-weight: 500; font-size: 1.1rem;">
                    –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
                </label>
                <textarea name="{{ question_form.text.name }}" 
                          id="{{ question_form.text.id_for_label }}" 
                          required
                          rows="3"
                          style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e0; border-radius: 5px; font-size: 1rem; resize: vertical;"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞">{{ question_form.text.value|default:'' }}</textarea>
            </div>

            <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
            <div style="margin-bottom: 2rem;">
                <label for="{{ question_form.explanation.id_for_label }}" 
                       style="display: block; color: #2d3748; margin-bottom: 0.5rem; font-weight: 500; font-size: 1.1rem;">
                    –û–±—ä—è—Å–Ω–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <textarea name="{{ question_form.explanation.name }}" 
                          id="{{ question_form.explanation.id_for_label }}" 
                          rows="2"
                          style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e0; border-radius: 5px; font-size: 1rem; resize: vertical;"
                          placeholder="–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞)">{{ question_form.explanation.value|default:'' }}</textarea>
                <div style="color: #718096; font-size: 0.875rem; margin-top: 0.25rem;">
                    –ü–æ–º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–Ω—è—Ç—å —Å–≤–æ—é –æ—à–∏–±–∫—É
                </div>
            </div>

            <!-- –û—Ç–≤–µ—Ç—ã -->
            <div style="margin-bottom: 2rem;">
                <label style="display: block; color: #2d3748; margin-bottom: 0.5rem; font-weight: 500; font-size: 1.1rem;">
                    –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                </label>
                
                <div id="answers-container">
                    {{ answer_formset.management_form }}
                    
                    {% for form in answer_formset %}
                        <div class="answer-row {% if form.is_correct.value %}correct-answer{% endif %}" data-form-index="{{ forloop.counter0 }}">
                            {{ form.id }}
                            {{ form.DELETE }}
                            
                            <div style="flex-shrink: 0;">
                                <input type="checkbox" 
                                       name="{{ form.is_correct.html_name }}" 
                                       id="{{ form.is_correct.id_for_label }}" 
                                       value="true"
                                       {% if form.is_correct.value %}checked{% endif %}
                                       style="width: 20px; height: 20px; cursor: pointer;"
                                       onchange="updateCorrectAnswer(this)">
                                <label for="{{ form.is_correct.id_for_label }}" style="margin-left: 0.5rem; cursor: pointer;">
                                    –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π
                                </label>
                            </div>
                            
                            <div class="answer-text">
                                <input type="text" 
                                       name="{{ form.text.html_name }}" 
                                       value="{{ form.text.value|default:'' }}"
                                       required
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 5px; font-size: 1rem;"
                                       placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞">
                                {{ form.order }}
                            </div>
                            
                            <button type="button" 
                                    class="remove-answer"
                                    onclick="removeAnswer(this)">
                                ‚úï
                            </button>
                        </div>
                    {% endfor %}
                </div>
                
                <div id="empty-form" style="display: none;">
                    <div class="answer-row">
                        <div style="flex-shrink: 0;">
                            <input type="checkbox" 
                                   name="__prefix__-is_correct" 
                                   value="true"
                                   style="width: 20px; height: 20px; cursor: pointer;"
                                   onchange="updateCorrectAnswer(this)">
                            <label style="margin-left: 0.5rem; cursor: pointer;">
                                –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π
                            </label>
                        </div>
                        
                        <div class="answer-text">
                            <input type="text" 
                                   name="__prefix__-text" 
                                   required
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 5px; font-size: 1rem;"
                                   placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞">
                            <input type="hidden" name="__prefix__-order" value="0">
                        </div>
                        
                        <button type="button" 
                                class="remove-answer"
                                onclick="removeAnswer(this)">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="add-answer-btn" onclick="addAnswer()">
                    + –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞
                </div>
                
                <div style="color: #718096; font-size: 0.875rem; margin-top: 0.5rem;">
                    {% if task.task_type == 'choice' %}
                        –û—Ç–º–µ—Ç—å—Ç–µ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    {% else %}
                        –û—Ç–º–µ—Ç—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                    {% endif %}
                </div>
            </div>

            <!-- –ü–æ—Ä—è–¥–æ–∫ -->
            <div style="margin-bottom: 2rem;">
                <label for="{{ question_form.order.id_for_label }}" 
                       style="display: block; color: #2d3748; margin-bottom: 0.5rem; font-weight: 500; font-size: 1.1rem;">
                    –ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–∞
                </label>
                <input type="number" 
                       name="{{ question_form.order.name }}" 
                       id="{{ question_form.order.id_for_label }}" 
                       value="{{ question_form.order.value|default:'0' }}"
                       min="0"
                       style="width: 100%; max-width: 200px; padding: 0.75rem; border: 1px solid #cbd5e0; border-radius: 5px; font-size: 1rem;">
                <div style="color: #718096; font-size: 0.875rem; margin-top: 0.25rem;">
                    –ß–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º —Ä–∞–Ω—å—à–µ –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                <div style="display: flex; gap: 1rem;">
                    <a href="{% url 'lesson_detail' task.lesson.id %}" 
                       style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #e2e8f0; color: #4a5568; text-decoration: none; border-radius: 5px; font-weight: 500;">
                        ‚Üê –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </a>
                    
                    <button type="submit" 
                            name="add_another"
                            style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #ed8936; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ
                    </button>
                </div>
                
                <button type="submit" 
                        name="save"
                        style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: #48bb78; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                </button>
            </div>
        </form>
    </div>

    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
    <div style="margin-top: 2rem; background: #f7fafc; border-radius: 10px; padding: 1.5rem;">
        <h3 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.1rem;">üí° –°–æ–≤–µ—Ç—ã –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            <div>
                <h4 style="color: #4a5568; margin-bottom: 0.5rem;">–î–ª—è —Ç–µ—Å—Ç–æ–≤ —Å –æ–¥–Ω–∏–º –æ—Ç–≤–µ—Ç–æ–º</h4>
                <ul style="color: #718096; font-size: 0.9rem; padding-left: 1.5rem; margin: 0;">
                    <li>–§–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ç–∫–æ –∏ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ</li>
                    <li>–î–µ–ª–∞–π—Ç–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–º–∏</li>
                    <li>–ò–∑–±–µ–≥–∞–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –≤ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞—Ö</li>
                </ul>
            </div>
            <div>
                <h4 style="color: #4a5568; margin-bottom: 0.5rem;">–î–ª—è —Ç–µ—Å—Ç–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏</h4>
                <ul style="color: #718096; font-size: 0.9rem; padding-left: 1.5rem; margin: 0;">
                    <li>–£–∫–∞–∑—ã–≤–∞–π—Ç–µ –≤ –≤–æ–ø—Ä–æ—Å–µ, —Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å</li>
                    <li>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</li>
                    <li>–ò–∑–±–µ–≥–∞–π—Ç–µ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    let formIndex = {{ answer_formset.total_form_count }};
    
    function updateCorrectAnswer(checkbox) {
        const answerRow = checkbox.closest('.answer-row');
        
        if ('{{ task.task_type }}' === 'choice') {
            // –î–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏ —Å –¥—Ä—É–≥–∏—Ö
            if (checkbox.checked) {
                document.querySelectorAll('#answers-container .answer-row input[type="checkbox"]').forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                        cb.closest('.answer-row').classList.remove('correct-answer');
                    }
                });
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å —Å—Ç—Ä–æ–∫–∏
        if (checkbox.checked) {
            answerRow.classList.add('correct-answer');
        } else {
            answerRow.classList.remove('correct-answer');
        }
    }
    
    function addAnswer() {
        const emptyForm = document.getElementById('empty-form').innerHTML;
        const newForm = emptyForm.replace(/__prefix__/g, formIndex);
        
        const container = document.getElementById('answers-container');
        const newRow = document.createElement('div');
        newRow.className = 'answer-row';
        newRow.setAttribute('data-form-index', formIndex);
        newRow.innerHTML = newForm;
        
        container.appendChild(newRow);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º TOTAL_FORMS
        const totalForms = document.getElementById('id_answers-TOTAL_FORMS');
        totalForms.value = ++formIndex;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞
        const newCheckbox = newRow.querySelector('input[type="checkbox"]');
        newCheckbox.addEventListener('change', function() {
            updateCorrectAnswer(this);
        });
    }
    
    function removeAnswer(button) {
        const answerRow = button.closest('.answer-row');
        const deleteInput = answerRow.querySelector('input[name$="-DELETE"]');
        
        if (deleteInput) {
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ–æ—Ä–º–∞, –ø–æ–º–µ—á–∞–µ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            deleteInput.value = 'on';
            answerRow.style.display = 'none';
        } else {
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞, —É–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
            answerRow.remove();
            formIndex--;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∏ TOTAL_FORMS
            const totalForms = document.getElementById('id_answers-TOTAL_FORMS');
            totalForms.value = formIndex;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–æ—Ä–º–∞—Ö
            document.querySelectorAll('#answers-container .answer-row').forEach((row, index) => {
                row.setAttribute('data-form-index', index);
                row.querySelectorAll('input, select').forEach(input => {
                    const name = input.name.replace(/\d+/, index);
                    input.name = name;
                    if (input.id) {
                        input.id = input.id.replace(/\d+/, index);
                    }
                });
            });
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('#answers-container input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCorrectAnswer(this);
            });
        });
    });
</script>
{% endblock %}